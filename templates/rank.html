<!DOCTYPE html>
<html>
<head>
    <title>{{ airing_details.season }} Karma Ranks</title>
    <meta name="description" content="The current /r/anime weekly engagement ranking discussion">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/karma_test.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/toolbar.css') }}">
    <script src="{{ url_for('static', filename='scripts/editBanner.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/toolbar.js') }}"></script>
</head>

<body>
    <div class="container">
        {# Header Section (Unchanged) #}
        <div class="header">
            <img class="snoo" src="{{ url_for('static', filename='assets/img/snoo.png') }}" alt="Snoo" loading="lazy">
            <div class="subheader">
                <div class="main-title"><span>/r/anime weekly engagement ranking &amp; discussion</span></div>
                <div class="subsubheader">
                    <div class="airing-period">{{ airing_details.airing_period }}</div>
                    <div class="legend">
                        <div><div class="icon"><img src="{{ url_for('static', filename='assets/svg/arrow-up.svg') }}"><img src="{{ url_for('static', filename='assets/svg/arrow-down.svg') }}"></div><span>Rank<br>change</span></div>
                        <div><div class="icon"><img src="{{ url_for('static', filename='assets/svg/caret-up.svg') }}"><img src="{{ url_for('static', filename='assets/svg/caret-down.svg') }}"></div><span>Karma<br>change</span></div>
                        <div><div class="icon" style="color: rgb(252, 103, 43);"><span>M</span></div><span>Myanimelist<br>score</span></div>
                        <div><span style="clip-path: polygon(0% 0%, 100% 0%, 100% 75%, 75% 75%, 75% 100%, 50% 75%, 0% 75%);width: 13px;height: 12px;background-color: white;"></span><span>No.of<br>Comments </span></div>
                    </div>
                </div>
                <div class="credits">
                   <div class="total-karma"><div class="text-container"><span>K</span> {{ sum_karma }}</div></div>
                </div>
            </div>
            <div class="week-container">
                <span class="season {{ airing_details.season }}">{{ airing_details.season }}</span>
                <div class="week {{ airing_details.season }}"><span>{{ airing_details.week_id }}</span></div>
            </div>
        </div>

        {# Macros (Condensed for brevity, kept your logic) #}
        {% macro rank_change_indicator(change, is_right=false) %}
            {% if change == 'returning' %}{{ back_symbol | safe }}
            {% elif change == 'new' %}
                {% if is_right %}<span class="right-rank-change new-entry" style="display:initial;">+</span>
                {% else %}<span class="rank-change new-entry">NEW</span>{% endif %}
            {% elif change|int == 0 %}
                <span class="{% if is_right %}right-rank-change{% else %}rank-change{% endif %} stable">&mdash;</span>
            {% else %}
                <span class="{% if is_right %}right-rank-change{% else %}rank-change{% endif %} {% if change|int > 0 %}positive{% else %}negative{% endif %}">
                    <svg class="arrow {% if change|int < 0 %}negative{% else %}positive{% endif %}" viewBox="0 0 117.7 110"><polygon points="60,0 0,58 40,58 40,110 80,110 80,58 120,58"></polygon></svg>
                    {{ change|int|abs }}
                </span>
            {% endif %}
        {% endmacro %}

        {% macro karma_change_indicator(change) %}
            <svg class="caret {% if change|int > 0 %}caret-up{% else %}caret-down{% endif %}" viewBox="0 0 512 512"><path d="M505.755,123.592c-8.341-8.341-21.824-8.341-30.165,0L256.005,343.176L36.421,123.592c-8.341-8.341-21.824-8.341-30.165,0 s-8.341,21.824,0,30.165l234.667,234.667c4.16,4.16,9.621,6.251,15.083,6.251c5.462,0,10.923-2.091,15.083-6.251l234.667-234.667 C514.096,145.416,514.096,131.933,505.755,123.592z"></path></svg>{{ change|int|abs }}
        {% endmacro %}

        {% macro get_title(entry) %}{{ entry.title_english if entry.title_english else entry.title }}{% endmacro %}
        {% macro get_banner(entry) %}{{ entry.banner.url if entry.banner else entry.images.large }}{% endmacro %}
        {% macro get_banner_offset(entry) %}{{ entry.banner.offset if entry.banner else "0px 0px" }}{% endmacro %}

        {# --- EPISODE CONTAINER --- #}
        <div class="episode-container">
            {% for left, right in complete_rankings %}
            <div class="row">

                {# === LEFT COLUMN (70%) === #}
                {% if left %}
                <div class="karma-entry left-column">
                    <div class="ranking">
                        <span class="rank">{{ left.current_rank }}</span>
                        {{ rank_change_indicator(left.rank_change) }}
                    </div>

                    <div class="details" style="background-image: url({{get_banner(left)}}); background-position: {{get_banner_offset(left)}};">
                        <a href="{{ left.images.large }}" target="_blank" class="external-link"></a>

                        <div class="part-1">
                            <span class="karma-change" style="display: {% if left.karma_change == 0 %}none{% else %}flex{% endif %};">{{karma_change_indicator(left.karma_change)}}</span>
                            <span class="karma">{{ left.karma }}</span>
                        </div>

                        <div class="part-2" style="justify-content: space-between">
                            <span class="title">{{ get_title(left) }}</span>

                            {# Chips Container #}
                            <div class="bottom-metadata" style="display: flex; align-items: flex-end; justify-content: space-between; gap: 8px; margin-top: 4px;">
                                <div class="chips-group" style="display: flex; flex-wrap: wrap; gap: 5px;">
                                    <span class="Studio" style="background-color: #fff; color: #000; padding: 2px 5px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">{{ left.studio | join(',') }}</span>
                                    <span style="background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.75rem;">
                                        {{ left.score }} <span class="neutral" style="color: orange;">M</span>
                                        <a class="external-link" href="https://myanimelist.net/anime/{{ left.mal_id }}" target="_blank"></a>
                                    </span>
                                    {# Comments #}
                                    <div class="comments" style="background: rgba(255,255,255,0.9); color: black; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; position: relative; display: inline-flex;">
                                        <span>{{ left.comments }}</span>
                                        {% if left.url %}<a href="{{ left.url }}" target="_blank" class="external-link"></a>{% else %}<a href="#" target="_blank" class="external-link"></a>{% endif %}
                                    </div>
                                    {% if left.streams.name %}
                                    <span class="{{ left.streams.name | capitalize}}" style="background: #333; color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.75rem; position: relative;">
                                        {{ left.streams.name | capitalize}}
                                        <a class="external-link" href="{{ left.streams.url }}" target="_blank"></a>
                                    </span>
                                    {% endif %}
                                </div>

                                <span class="episode-number">
                                    <span class="poll-blue">E</span>
                                    {% set ep = left.episode|int(default=0) %}
                                    {% set total = left.num_episodes|int(default=0) %}
                                    {{ ep }}{% if ep == total and ep != 0 %} (Final) {% endif %}
                                </span>
                            </div>
                        </div>
                        <button class="edit-banner-button">Change or Edit this Banner</button>
                    </div>
                </div>
                {% endif %}

                {# === RIGHT COLUMN (30%) === #}
                {% if right %}
                <div class="karma-entry right-column">
                    <div class="details rightBanner" style="background-image: url('{{ right.images.large }}'); background-position: 0px 0px;">
                        <a href="{{ right.images.large }}" target="_blank" class="external-link"></a>

                        <div class="part-2">
                            <span class="title rightTitle">{{ get_title(right) }}</span>
                            <span class="karma rightKarma">{{ right.karma }}</span>

                            <div class="rightContainer">
                                <span class="{{ right.streams.name | capitalize }}-logo">{{ right.streams.name | capitalize}}</span>
                                <div class="details-container">
                                    <div class="comments-wrapper" style="filter: drop-shadow(3px 1px 1px rgba(0, 0, 0, 0.8));">
                                        <div class="right-comments"><span>{{ right.comments }}</span></div>
                                    </div>
                                    <span class="rightEpisode">E {{ right.episode | int }}</span>
                                    <span class="karma-change rightChange" style="display: {% if right.karma_change == 0 %}none{% else %}flex{% endif %};">
                                        {{ karma_change_indicator(right.karma_change) }}
                                    </span>
                                    <div class="right-ranking">{{ rank_change_indicator(right.rank_change, true) }}</div>
                                </div>
                                <div class="rightRank"><span>{{ right.current_rank }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {# Divider removed or kept minimal between rows #}
            <div style="height: 5px;"></div>
            {% endfor %}
        </div>
    </div>
    {# Toolbar buttons ... #}
</body>
</html>
