{% extends "base.html" if legacy else "new_base.html" %}

{% block title %}Anime Production Committees{% endblock %}

{% block content %}
<main>
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Anime Production Committees</h2>
            <div class="last-updated">Last updated: <span id="committee-update-time">{{ current_time }}</span></div>
        </div>

        <div class="filter-controls">
            <form id="filter-form" method="get" action="{{ url_for('committees') }}">
                <select id="season-filter" name="season" class="filter-select">
                    <option value="all" {% if not current_season %}selected{% endif %}>All Seasons</option>
                    {% for season in filter_seasons %}
                    <option value="{{ season }}" {% if current_season==season %}selected{% endif %}>
                        {{ season|capitalize }}
                    </option>
                    {% endfor %}
                </select>

                <select id="year-filter" name="year" class="filter-select">
                    <option value="all" {% if not current_year %}selected{% endif %}>All Years</option>
                    {% for year in filter_years %}
                    <option value="{{ year }}" {% if current_year==year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>

                <button type="submit" class="filter-button">Apply Filters</button>

                <input type="text" id="show-search" class="search-input"
                    placeholder="Search by anime title or studio...">
            </form>
        </div>

        <div class="committee-container">
            {% for show in shows %}
            <div class="committee-card" data-year="{{ show.year }}" data-season="{{ show.season }}">
                <div class="committee-header">
                    <div class="anime-info">
                        {% if show.images and show.images.medium %}
                        <img src="{{ show.images.medium }}" alt="{{ show.title }}" class="anime-img">
                        {% else %}
                        <div class="anime-img placeholder-img"></div>
                        {% endif %}

                        <div class="anime-details">
                            <h3 class="anime-title">{{ show.title_english or show.title }}</h3>
                            <div class="anime-meta">
                                <span class="season-badge {{ show.season }}">{{ show.season|capitalize }} {{ show.year
                                    }}</span>
                                {% if show.score %}
                                <span class="score-badge"><i class="fa-solid fa-star"></i> {{ show.score }}</span>
                                {% endif %}
                                {% if show.main_producer %}
                                <span class="producer-badge">Main: {{ show.main_producer.name }}</span>
                                {% endif %}
                            </div>

                            {% if show.genres %}
                            <div class="genre-tags">
                                {% for genre in show.genres[:3] %}
                                <span class="genre-tag">{{ genre.name }}</span>
                                {% endfor %}
                                {% if show.genres|length > 3 %}
                                <span class="genre-tag more">+{{ show.genres|length - 3 }}</span>
                                {% endif %}
                            </div>
                            {% endif %}

                            {% if show.studios %}
                            <div class="studio-info">
                                <span class="studio-label">Studio:</span>
                                {% for studio in show.studios %}
                                <span class="studio-name">{{ studio.name }}</span>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if show.streams and show.streams.url %}
                    <div class="anime-links">
                        <a href="{{ show.streams.url }}" target="_blank" class="watch-link">
                            <i class="fa-solid fa-play"></i> Watch
                        </a>
                    </div>
                    {% endif %}
                </div>

                <div class="committee-members">
                    <h4>Production Committee</h4>
                    <div class="producer-grid">
                        {% for producer in show.committee %}
                        <div class="producer-card">
                            <a href="{{ url_for('producer_detail', producer_id=producer.id) }}" class="producer-link">
                                <div class="producer-header">
                                    {% if producer.image %}
                                    <img src="{{ producer.image }}" alt="{{ producer.name }}" class="producer-img">
                                    {% else %}
                                    <div class="producer-img placeholder-img"></div>
                                    {% endif %}
                                    <h5 class="producer-name">{{ producer.name }}</h5>
                                </div>
                                {% if producer.established or producer.favorites %}
                                <div class="producer-meta">
                                    {% if producer.established %}
                                    <span class="established">Est. {{ producer.established[:10] }}</span>
                                    {% endif %}
                                    {% if producer.favorites %}
                                    <span class="favorites"><i class="fa-solid fa-heart"></i> {{ producer.favorites
                                        }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if shows|length == 0 %}
        <div class="empty-state">
            <i class="fa-solid fa-film-slash"></i>
            <p>No anime shows found with the current filters</p>
            <span>Try adjusting your filters or search criteria</span>
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if total_shows > per_page %}
        <div class="pagination">
            {% set pages = (total_shows / per_page)|round(0, 'ceil')|int %}
            {% if page > 1 %}
            <a href="{{ url_for('production_committees', page=page-1, season=current_season, year=current_year) }}"
                class="page-link">
                <i class="fa-solid fa-chevron-left"></i> Previous
            </a>
            {% endif %}

            {% for p in range(max(1, page - 2), min(pages + 1, page + 3)) %}
            <a href="{{ url_for('production_committees', page=p, season=current_season, year=current_year) }}"
                class="page-link {% if p == page %}active{% endif %}">
                {{ p }}
            </a>
            {% endfor %}

            {% if page < pages %} <a
                href="{{ url_for('committees', page=page+1, season=current_season, year=current_year) }}"
                class="page-link">
                Next <i class="fa-solid fa-chevron-right"></i>
                </a>
                {% endif %}
        </div>
        {% endif %}
    </div>
</main>

<script>
    // Client-side search functionality
    const showSearch = document.getElementById('show-search');
    const committeeCards = document.querySelectorAll('.committee-card');

    showSearch.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();

        committeeCards.forEach(card => {
            const animeTitle = card.querySelector('.anime-title').textContent.toLowerCase();
            const studioElements = card.querySelectorAll('.studio-name');
            const studios = Array.from(studioElements).map(el => el.textContent.toLowerCase());
            const producerElements = card.querySelectorAll('.producer-name');
            const producers = Array.from(producerElements).map(el => el.textContent.toLowerCase());

            // Check if search term is in any of the relevant fields
            const matchesTitle = animeTitle.includes(searchTerm);
            const matchesStudio = studios.some(studio => studio.includes(searchTerm));
            const matchesProducer = producers.some(producer => producer.includes(searchTerm));

            if (searchTerm === '' || matchesTitle || matchesStudio || matchesProducer) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}